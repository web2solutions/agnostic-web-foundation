<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Hello Backbone</title>
	<body>
        <script type="text/javascript" src="lib/jquery-min.js"></script>
        <script type="text/javascript" src="lib/underscore-min.js"></script>
        <script type="text/javascript" src="lib/backbone-min.js"></script>
        <script type="text/javascript" src="backbone-indexeddb.js"></script>
        <script type="text/javascript">

        function addAllMovies(movies, done) {
            if (!movies) {
                movies = [{
                    title: "Hello",
                    format: "blueray",
                    year: 2006
                }, {
                    title: "Bonjour",
                    format: "dvd",
                    year: 2002
                }, {
                    title: "Halo",
                    format: "blueray",
                    year: 2007
                }, {
                    title: "Nihao",
                    format: "streaming",
                    year: 2004
                }, {
                    title: "Ciao",
                    format: "dvd",
                    year: 2009
                }];
            }
            var movie = movies.shift();
            if (movie) {
                var m = new Movie();
                m.save(movie, {
                    success: function () {
                        addAllMovies(movies, done);
                    },
                    error: function (o, error) {
                        start();
                        equal(true, false, error.error.target.webkitErrorMessage);
                    }
                });
            } else {
                done();
            }
        }
            var database = {
                id: "movies-database",
                description: "The database for the Movies",
                migrations: [{
                    version: 1,
                    migrate: function (transaction, next) {
                        var store = transaction.db.createObjectStore("movies");
                        next();
                    }
                }]
            };

            var Movie = Backbone.Model.extend({
                database: database,
                storeName: "movies"
            });

            var Theater = Backbone.Collection.extend({
                database: database,
                storeName: "movies",
                model: Movie
            });


            var m = new Movie();
                m.save({
                    title: "Teyyyy",
                    format: "blueray",
                    year: 2006
                }, {
                    success: function () {
                        console.info('created doc ', m.toJSON())
                    },
                    error: function () {
                        console.error(o, error)
                    }
                });

            addAllMovies(null, () => {
                var theater = new Theater();
                theater.on("change", function() {
                    console.error(arguments)
                });
                theater.fetch({
                    success: function () {
                        console.log(theater.models[1].toJSON())
                        theater.models[1].set("title", "xxxxxxxx");
                        console.log(theater.models[1].toJSON())
                        theater.models[1].save(theater.models[1].toJSON(), {
                            success: function () {
                                console.log('saved', theater.models[1].toJSON())
                            },
                            error: function (o, error) {
                                console.error(o, error)
                            }
                        });

                        // console.log(theater.models[1].toJSON(), theater.models[1])
                    }
                });
            })
            var theater = new Theater();
                theater.on("change", function() {
                    console.error(arguments)
                });
                theater.fetch({
                    success: function () {
                        console.warn(theater.models)
                        console.warn('original doc -> ', theater.models[1].toJSON())
                        
                        theater.models[1].set("title", "xxxx");
                        console.warn('updated in memory doc -> ', theater.models[1].toJSON())
                        
                        theater.models[1].save(theater.models[1].toJSON(), {
                            success: function () {
                                console.warn('index db saved doc -> ', theater.models[1].toJSON())
                            },
                            error: function (o, error) {
                                console.error(o, error)
                            }
                        });

                        // console.log(theater.models[1].toJSON(), theater.models[1])
                    }
                });
        </script>
	</body>
</html>